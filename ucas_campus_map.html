<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCASMap-å›½ç§‘å¤§æ ¡å›­æ´»åŠ¨åœ°å›¾</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 120px);
        }
        
        .sidebar {
            width: 350px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 1000;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .filter-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .filter-group select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .campus-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .campus-btn {
            padding: 6px 12px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .campus-btn.active {
            background: #3498db;
            color: white;
        }
        
        .campus-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .stats {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 13px;
        }
        
        .stat-value {
            color: #2c3e50;
            font-weight: 600;
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .activity-list {
            padding: 20px;
        }
        
        .activity-item {
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #3498db;
        }
        
        .activity-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left-color: #e74c3c;
        }
        
        .activity-item.selected {
            border-color: #e74c3c;
            background: #fff5f5;
        }
        
        .activity-date {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .activity-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .activity-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .activity-type {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .type-academic {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .type-student {
            background: #f3e5f5;
            color: #6a1b9a;
        }
        
        .type-other {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .activity-location {
            font-size: 11px;
            color: #27ae60;
            font-weight: 500;
        }
        
        /* Custom Leaflet Styles */
        .custom-popup {
            font-family: inherit;
        }
        
        .popup-header {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 12px;
            margin: -15px -15px 15px -15px;
            border-radius: 4px 4px 0 0;
        }
        
        .popup-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .popup-location {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .popup-activities {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .popup-activity {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .popup-activity:last-child {
            border-bottom: none;
        }
        
        .popup-activity-date {
            font-size: 11px;
            color: #7f8c8d;
        }
        
        .popup-activity-title {
            font-size: 12px;
            color: #2c3e50;
            margin: 2px 0;
            line-height: 1.3;
        }
        
        .popup-activity-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 500;
        }
        
        /* Loading animation */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            color: #7f8c8d;
        }
        
        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #3498db;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
                order: 2;
            }
            
            .map-container {
                height: 60vh;
                order: 1;
            }
        }
        
        /* Map controls positioning */
        .leaflet-control-layers {
            margin-right: 60px !important;
            margin-top: 10px !important;
        }
        
        .map-upload-area {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1001;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 120px;
        }
        
        .map-info-area {
            position: absolute;
            bottom: 60px;
            right: 10px;
            z-index: 1001;
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
            color: #666;
            max-width: 200px;
        }
        
        .upload-btn {
            padding: 8px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.3s ease;
            width: 100%;
            text-align: center;
        }
        
        .upload-btn:hover {
            background: #2980b9;
        }
        
        .map-status {
            margin-top: 8px;
            padding: 4px 8px;
            background: #e8f5e8;
            color: #2e7d32;
            border-radius: 4px;
            font-size: 10px;
            text-align: center;
        }
        
        .keyboard-hints {
            margin-top: 8px;
            font-size: 10px;
            color: #7f8c8d;
            line-height: 1.3;
        }
        
        #imageUpload {
            display: none;
        }
        
        .campus-marker {
            background: #fff;
            border: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #3498db;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .campus-marker:hover {
            transform: scale(1.2);
            border-color: #e74c3c;
            color: #e74c3c;
        }
        
        .activity-item.expired {
            opacity: 0.6;
            border-left-color: #95a5a6;
        }
        
        .activity-item.upcoming {
            border-left-color: #27ae60;
            background: linear-gradient(to right, #f8fff8, white);
        }
        
        .activity-item.upcoming::before {
            content: 'ğŸ•’';
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 16px;
        }
        
        .activity-item {
            position: relative;
        }
        
        .activity-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .status-upcoming {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-past {
            background: #f5f5f5;
            color: #757575;
        }
        
        .current-time-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .time-display {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .current-date {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .current-time-large {
            font-size: 28px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .current-weekday {
            font-size: 12px;
            opacity: 0.8;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ ä¸­å›½ç§‘å­¦é™¢å¤§å­¦æ ¡å›­æ´»åŠ¨åœ°å›¾</h1>
        <p>2025å¹´5æœˆæ ¡å›­æ´»åŠ¨ç©ºé—´åˆ†å¸ƒ - ç‚¹å‡»åœ°å›¾æ ‡è®°æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <div class="controls">
                <div class="current-time-widget">
                    <div class="time-display">
                        <div class="current-date" id="currentDate">2025å¹´05æœˆ30æ—¥</div>
                        <div class="current-time-large" id="currentTimeLarge">13:30:00</div>
                        <div class="current-weekday" id="currentWeekday">æ˜ŸæœŸäº”</div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label>ğŸ“… æ´»åŠ¨æ—¶é—´çŠ¶æ€</label>
                    <select id="statusFilter">
                        <option value="">å…¨éƒ¨æ´»åŠ¨</option>
                        <option value="upcoming" selected>å³å°†è¿›è¡Œ</option>
                        <option value="past">å·²ç»“æŸ</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>ğŸ“… æ´»åŠ¨æ—¥æœŸç­›é€‰</label>
                    <select id="dateFilter">
                        <option value="">å…¨éƒ¨æ—¥æœŸ</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>ğŸ·ï¸ æ´»åŠ¨ç±»å‹ç­›é€‰</label>
                    <select id="typeFilter">
                        <option value="">å…¨éƒ¨ç±»å‹</option>
                        <option value="å­¦æœ¯æ´»åŠ¨">å­¦æœ¯æ´»åŠ¨</option>
                        <option value="å­¦ç”Ÿæ´»åŠ¨">å­¦ç”Ÿæ´»åŠ¨</option>
                        <option value="å…¶ä»–æ´»åŠ¨">å…¶ä»–æ´»åŠ¨</option>
                    </select>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-label">æ ¡å›­æ´»åŠ¨æ•°é‡</span>
                    <span class="stat-value" id="visibleCount">16</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æ´»åŠ¨åœ°ç‚¹æ•°é‡</span>
                    <span class="stat-value" id="locationCount">3</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">å³å°†è¿›è¡Œ</span>
                    <span class="stat-value" id="upcomingCount">0</span>
                </div>
            </div>
            
            <div class="activity-list">
                <div id="activityItems">
                    <div class="loading">åŠ è½½æ´»åŠ¨æ•°æ®ä¸­...</div>
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            
            <div class="map-upload-area">
                <input type="file" id="imageUpload" accept="image/*">
                <button class="upload-btn" onclick="document.getElementById('imageUpload').click()">
                    ğŸ“ ä¸Šä¼ åœ°å›¾
                </button>
                <div class="map-status" id="mapStatus">ä½¿ç”¨é¢„è®¾åœ°å›¾</div>
            </div>
            
            <div class="map-info-area">
                <div style="font-weight: 600; margin-bottom: 5px;">ğŸ® å¿«æ·é”®</div>
                <div class="keyboard-hints">
                    <div>1 - æ‰‹ç»˜åœ°å›¾</div>
                    <div>2 - è¡—é“åœ°å›¾</div>
                    <div>3 - å«æ˜Ÿåœ°å›¾</div>
                    <div>ESC - é‡ç½®ç­›é€‰</div>
                </div>
                <div style="margin-top: 8px; font-size: 10px; color: #95a5a6;">
                    åæ ‡èŒƒå›´: 40.3986Â°-40.4164Â°N<br>
                    116.6673Â°-116.6914Â°E
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        // æ´»åŠ¨æ•°æ®
        const activitiesData = [
            {date: "2025-05-02", weekday: "æ˜ŸæœŸäº”", title: "KITS Journal Club 0502", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘-7å·æ¥¼401ä¼šè®®å®¤", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-04", weekday: "æ˜ŸæœŸæ—¥", title: "éå¹³è¡¡æ€ç»Ÿè®¡ç‰©ç†æœªæ¥å‘å±•æ–¹å‘å›½é™…ç ”è®¨ä¼š-1", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–æ ¡åŒº-ä¼šè®®ä¸­å¿ƒ", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-05", weekday: "æ˜ŸæœŸä¸€", title: "éå¹³è¡¡æ€ç»Ÿè®¡ç‰©ç†æœªæ¥å‘å±•æ–¹å‘å›½é™…ç ”è®¨ä¼š-2", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–æ ¡åŒº-ä¼šè®®ä¸­å¿ƒ", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-06", weekday: "æ˜ŸæœŸäºŒ", title: "äº¤é”™ç£ä½“æ–°ç‰©æ€§æ¢ç´¢ä¸è°ƒæ§ç ”ç©¶", type: "å…¶ä»–æ´»åŠ¨", location: "ä¸­å…³æ‘æ ¡åŒº-ç‰©ç†ç§‘å­¦å­¦é™¢", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-06", weekday: "æ˜ŸæœŸäºŒ", title: "\"SEMå·¥å•†ç®¡ç†\"ç³»åˆ—è®²åº§", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘æ ¡åŒº-ç»ç®¡å­¦é™¢", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-06", weekday: "æ˜ŸæœŸäºŒ", title: "éå¹³è¡¡æ€ç»Ÿè®¡ç‰©ç†æœªæ¥å‘å±•æ–¹å‘å›½é™…ç ”è®¨ä¼š-3", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–æ ¡åŒº-ä¼šè®®ä¸­å¿ƒ", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-07", weekday: "æ˜ŸæœŸä¸‰", title: "\"è®¸å›½å¿—ç®¡ç†ç§‘å­¦è®²åº§\" é’å¹´å­¦è€…è®ºå›", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘æ ¡åŒº-ç»ç®¡å­¦é™¢", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-07", weekday: "æ˜ŸæœŸä¸‰", title: "éå¹³è¡¡æ€ç»Ÿè®¡ç‰©ç†æœªæ¥å‘å±•æ–¹å‘å›½é™…ç ”è®¨ä¼š-4", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–æ ¡åŒº-ä¼šè®®ä¸­å¿ƒ", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-08", weekday: "æ˜ŸæœŸå››", title: "æ˜å¾·è®²å ‚M1057ï¼šåŸå§‹æ€ç»´çš„ä¸¤é‡æ€§ â€”â€”å…¼è®ºç°ä»£åˆ›é€ æ€§æ€ç»´æ–¹å¼", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–ä¸œåŒºæ•™2-101", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-08", weekday: "æ˜ŸæœŸå››", title: "éå¹³è¡¡æ€ç»Ÿè®¡ç‰©ç†æœªæ¥å‘å±•æ–¹å‘å›½é™…ç ”è®¨ä¼š-5", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–æ ¡åŒº-ä¼šè®®ä¸­å¿ƒ", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-09", weekday: "æ˜ŸæœŸäº”", title: "KITS Journal Club 0509", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘-7å·æ¥¼401ä¼šè®®å®¤", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-09", weekday: "æ˜ŸæœŸäº”", title: "éå¹³è¡¡æ€ç»Ÿè®¡ç‰©ç†æœªæ¥å‘å±•æ–¹å‘å›½é™…ç ”è®¨ä¼š-6", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–æ ¡åŒº-ä¼šè®®ä¸­å¿ƒ", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-10", weekday: "æ˜ŸæœŸå…­", title: "äººæ–‡å­¦é™¢ç§‘å­¦æŠ€æœ¯å²ç³»2025å¹´ç¡•ã€åšå­¦ä½è®ºæ–‡ç­”è¾©ä¼š", type: "å­¦ç”Ÿæ´»åŠ¨", location: "ç‰æ³‰è·¯-äººæ–‡æ¥¼223ä¼šè®®å®¤", contact: "åº·ä¸½å©· 17801121266", time: "08:00-18:00"},
            {date: "2025-05-13", weekday: "æ˜ŸæœŸäºŒ", title: "æ˜å¾·è®²å ‚M1058ï¼šè‰ºæœ¯å¿ƒç†ç–—æ„ˆâ€”â€”å‘å†…æ¢ç´¢", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–ä¸œåŒºæ•™2-101", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-13", weekday: "æ˜ŸæœŸäºŒ", title: "\"é‚¹è‡³åº„è®²åº§\"æ°å‡ºå­¦è€…è®ºå›", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å›½ç§‘å­¦é™¢æ•°å­¦ä¸ç³»ç»Ÿç§‘å­¦ç ”ç©¶é™¢å—æ¥¼N204", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-13", weekday: "æ˜ŸæœŸäºŒ", title: "æ•°å­—ç»æµç³»åˆ—è®²åº§", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘æ ¡åŒº-ç»ç®¡å­¦é™¢", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-14", weekday: "æ˜ŸæœŸä¸‰", title: "è‰ºæœ¯ä¸äººæ–‡ä¿®å…»è®²åº§ç³»åˆ—ç¬¬194è®²ï¼šã€Šå­™å­å…µæ³•ã€‹ä¸ä¸­å›½å†›äº‹æ–‡åŒ–", type: "å­¦æœ¯æ´»åŠ¨", location: "ç‰æ³‰è·¯æ ¡åŒº-ç¤¼å ‚", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-14", weekday: "æ˜ŸæœŸä¸‰", title: "æ˜å¾·è®²å ‚M1060ï¼š\"äº”å››\"æ‘„å½±ï¼šå›¾åƒçš„é™„ä¼šã€æŒªç”¨ä¸çœŸå®æ€§é—®é¢˜", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–ä¸œåŒºæ•™2-101", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-14", weekday: "æ˜ŸæœŸä¸‰", title: "æ˜å¾·è®²å ‚M1059ï¼šä»¥\"è§„çŸ©\"ä¸€è¯ä¸ºçº¿ç´¢çœ‹ã€Šè¥é€ æ³•å¼ã€‹å’Œã€Šé²ç­ç»ã€‹ä¸­\"å„’ã€åŒ ã€å·«\"çš„çŸ¥è¯†å’Œå®è·µ", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–ä¸œåŒºæ•™2-101", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-14", weekday: "æ˜ŸæœŸä¸‰", title: "\"è®¸å›½å¿—ç®¡ç†ç§‘å­¦è®²åº§\" é’å¹´å­¦è€…è®ºå›", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘æ ¡åŒº-ç»ç®¡å­¦é™¢", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-14", weekday: "æ˜ŸæœŸä¸‰", title: "ç‰æ³‰é‡‘èè®²å ‚", type: "å­¦æœ¯æ´»åŠ¨", location: "ç‰æ³‰è·¯æ ¡åŒº-ç»ç®¡å­¦é™¢", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-15", weekday: "æ˜ŸæœŸå››", title: "æ˜å¾·è®²å ‚M1062ï¼šé›æ­£çš‡å¸ä¸åº·ä¹¾ç››ä¸–", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–ä¸œåŒºæ•™2-101", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-15", weekday: "æ˜ŸæœŸå››", title: "æ˜å¾·è®²å ‚M1061ï¼šèŠ±é¸Ÿç”»çš„å‰ç¥¥å¯†ç  \"æ´»\"åœ¨å½±è§†é‡Œçš„ç”»", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–ä¸œåŒºæ•™2-101", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-15", weekday: "æ˜ŸæœŸå››", title: "\"SEMå·¥å•†ç®¡ç†\"ç³»åˆ—è®²åº§", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘æ ¡åŒº-ç»ç®¡å­¦é™¢", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-16", weekday: "æ˜ŸæœŸäº”", title: "ã€ç§‘å­¦å‰æ²¿è®²åº§ã€‘å¤šä½“é‡å­çº ç¼ çš„åˆ»ç”»å’Œåº”ç”¨", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘æ ¡åŒº-ç‰©ç†ç§‘å­¦å­¦é™¢", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-16", weekday: "æ˜ŸæœŸäº”", title: "KITS Journal Club 0516", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘-7å·æ¥¼401ä¼šè®®å®¤", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-19", weekday: "æ˜ŸæœŸä¸€", title: "æ˜å¾·è®²å ‚M1063ï¼šå†å²è§†é˜ˆä¸‹çš„ä¸­å›½å…±äº§å…šä¸ºä»€ä¹ˆèƒ½", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–ä¸œåŒºæ•™2-101", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-20", weekday: "æ˜ŸæœŸäºŒ", title: "æ˜å¾·è®²å ‚M1064ï¼šé›•å¡‘å·¡ç¤¼", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–ä¸œåŒºæ•™2-101", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-21", weekday: "æ˜ŸæœŸä¸‰", title: "\"è®¸å›½å¿—ç®¡ç†ç§‘å­¦è®²åº§\" é’å¹´å­¦è€…è®ºå›", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘æ ¡åŒº-ç»ç®¡å­¦é™¢", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-22", weekday: "æ˜ŸæœŸå››", title: "æ•°å­—ç»æµå‘å±•ä¸æ²»ç†è®ºå›", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–æ ¡åŒº-ä¼šè®®ä¸­å¿ƒ", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-22", weekday: "æ˜ŸæœŸå››", title: "\"SEMå·¥å•†ç®¡ç†\"ç³»åˆ—è®²åº§", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘æ ¡åŒº-ç»ç®¡å­¦é™¢", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-23", weekday: "æ˜ŸæœŸäº”", title: "æ°å‡ºç§‘å­¦å®¶ç³»åˆ—è®²åº§", type: "å­¦æœ¯æ´»åŠ¨", location: "é›æ –æ¹–æ ¡åŒº-å­¦æœ¯äº¤æµä¸­å¿ƒ", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-23", weekday: "æ˜ŸæœŸäº”", title: "KITS Journal Club 0523", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘-7å·æ¥¼401ä¼šè®®å®¤", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-24", weekday: "æ˜ŸæœŸå…­", title: "2025å¹´å›½ç§‘å¤§æœ¬ç§‘æ¸¯æ¾³å°ç»¼åˆè¯„ä»·é¢è¯•Dç»„", type: "å­¦ç”Ÿæ´»åŠ¨", location: "ç‰æ³‰è·¯æ ¡åŒº-æ‹›ç”ŸåŠå…¬å®¤", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-26", weekday: "æ˜ŸæœŸä¸€", title: "\"è®¸å›½å¿—ç®¡ç†ç§‘å­¦è®²åº§\" é’å¹´å­¦è€…è®ºå›", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘æ ¡åŒº-ç»ç®¡å­¦é™¢", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-27", weekday: "æ˜ŸæœŸäºŒ", title: "\"é‚¹è‡³åº„è®²åº§\"æ°å‡ºå­¦è€…è®ºå›", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å›½ç§‘å­¦é™¢æ•°å­¦ä¸ç³»ç»Ÿç§‘å­¦ç ”ç©¶é™¢å—æ¥¼N204", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-28", weekday: "æ˜ŸæœŸä¸‰", title: "\"è®¸å›½å¿—ç®¡ç†ç§‘å­¦è®²åº§\" é’å¹´å­¦è€…è®ºå›", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘æ ¡åŒº-ç»ç®¡å­¦é™¢", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-28", weekday: "æ˜ŸæœŸä¸‰", title: "\"SEMå·¥å•†ç®¡ç†\"ç³»åˆ—è®²åº§", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘æ ¡åŒº-ç»ç®¡å­¦é™¢", contact: "", time: "å¾…ç¡®è®¤"},
            {date: "2025-05-30", weekday: "æ˜ŸæœŸäº”", title: "KITS Journal Club 0530", type: "å­¦æœ¯æ´»åŠ¨", location: "ä¸­å…³æ‘-7å·æ¥¼401ä¼šè®®å®¤", contact: "", time: "å¾…ç¡®è®¤"}
        ];
        
        // åœ°ç‚¹åæ ‡æ˜ å°„ (æ›´æ–°é›æ –æ¹–æ ¡åŒºåæ ‡)
        const locationCoordinates = {
            "ä¸­å…³æ‘-7å·æ¥¼401ä¼šè®®å®¤": [39.9750, 116.3150],
            "ä¸­å…³æ‘æ ¡åŒº-ç»ç®¡å­¦é™¢": [39.9760, 116.3160],
            "ä¸­å…³æ‘æ ¡åŒº-ç‰©ç†ç§‘å­¦å­¦é™¢": [39.9740, 116.3140],
            "é›æ –æ¹–æ ¡åŒº-ä¼šè®®ä¸­å¿ƒ": [40.4064, 116.6749],
            "é›æ –æ¹–ä¸œåŒºæ•™2-101": [40.4064, 116.6783],
            "é›æ –æ¹–æ ¡åŒº-å­¦æœ¯äº¤æµä¸­å¿ƒ": [40.4064, 116.6750],
            "ç‰æ³‰è·¯-äººæ–‡æ¥¼223ä¼šè®®å®¤": [39.9180, 116.2650],
            "ç‰æ³‰è·¯æ ¡åŒº-ç¤¼å ‚": [39.9190, 116.2660],
            "ç‰æ³‰è·¯æ ¡åŒº-ç»ç®¡å­¦é™¢": [39.9170, 116.2640],
            "ç‰æ³‰è·¯æ ¡åŒº-æ‹›ç”ŸåŠå…¬å®¤": [39.9185, 116.2655],
            "ä¸­å›½ç§‘å­¦é™¢æ•°å­¦ä¸ç³»ç»Ÿç§‘å­¦ç ”ç©¶é™¢å—æ¥¼N204": [39.9780, 116.3200]
        };
        
        // å…¨å±€å˜é‡
        let map;
        let markers = [];
        let filteredActivities = [];
        let selectedMarker = null;
        let campusImageOverlay = null;
        let baseLayers = {};
        let layerControl = null;
        
        // å½“å‰æ—¶é—´ 
        const currentDateTime = new Date();
        
        // ä»…æ˜¾ç¤ºé›æ –æ¹–æ ¡åŒºçš„æ´»åŠ¨
        const yanqihuActivities = activitiesData.filter(activity => 
            activity.location.includes('é›æ –æ¹–')
        );
        
        // é›æ –æ¹–æ ¡åŒºçš„åœ°ç†èŒƒå›´ (æ ¹æ®æ‰‹ç»˜åœ°å›¾åæ ‡è°ƒæ•´)
        const yanqihuBounds = [[40.3986, 116.6673], [40.4164, 116.6914]];
        
        // æ‰‹ç»˜åœ°å›¾çš„URL (GitHubä¸Šçš„å›¾ç‰‡)
        const handDrawnMapURL = 'https://raw.githubusercontent.com/JiaweiYI/UCASMap/main/UCAS%20map%20jimeng.jpeg';
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            // åˆ›å»ºåœ°å›¾ï¼Œä»¥é›æ –æ¹–æ ¡åŒºä¸ºä¸­å¿ƒ
            const centerLat = (40.3986 + 40.4164) / 2;
            const centerLng = (116.6673 + 116.6914) / 2;
            map = L.map('map').setView([centerLat, centerLng], 16);
            
            // é™åˆ¶åœ°å›¾æ˜¾ç¤ºèŒƒå›´ä¸ºé›æ –æ¹–æ ¡åŒº
            map.setMaxBounds(yanqihuBounds);
            map.options.minZoom = 14;
            map.options.maxZoom = 18;
            
            // åˆ›å»ºåŸºç¡€å›¾å±‚
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            });
            
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Â© Esri'
            });
            
            // åˆ›å»ºæ‰‹ç»˜åœ°å›¾å›¾å±‚
            createHandDrawnMapLayer();
            
            // è®¾ç½®åŸºç¡€å›¾å±‚
            baseLayers = {
                "ğŸ¨ æ‰‹ç»˜æ ¡å›­åœ°å›¾": campusImageOverlay,
                "ğŸŒ OpenStreetMap": osmLayer,
                "ğŸ›°ï¸ å«æ˜Ÿåœ°å›¾": satelliteLayer
            };
            
            // è®¾ç½®æ‰‹ç»˜åœ°å›¾ä¸ºé»˜è®¤å›¾å±‚
            campusImageOverlay.addTo(map);
            updateMapStatus('æ‰‹ç»˜åœ°å›¾åŠ è½½ä¸­...');
            
            // åˆå§‹åŒ–è¿‡æ»¤åçš„æ´»åŠ¨æ•°æ®
            filteredActivities = [...yanqihuActivities];
            
            // åˆ›å»ºæ ‡è®°
            createMarkers();
            
            // åˆå§‹åŒ–ä¾§è¾¹æ 
            initSidebar();
            
            // æ·»åŠ å›¾å±‚æ§åˆ¶
            addLayerControl();
            
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            updateCurrentTime();
            
            // åº”ç”¨é»˜è®¤ç­›é€‰ï¼ˆåªæ˜¾ç¤ºå³å°†è¿›è¡Œçš„æ´»åŠ¨ï¼‰
            applyFilters();
        }
        
        // æ›´æ–°å½“å‰æ—¶é—´æ˜¾ç¤º
        function updateCurrentTime() {
            const dateElement = document.getElementById('currentDate');
            const timeLargeElement = document.getElementById('currentTimeLarge');
            const weekdayElement = document.getElementById('currentWeekday');
            const headerTimeElement = document.getElementById('currentTime');
            
            const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
            
            function updateTime() {
                // æ›´æ–°å½“å‰æ—¶é—´ï¼ˆæ¯ç§’é€’å¢ï¼‰
                currentDateTime.setSeconds(currentDateTime.getSeconds() + 1);
                
                // æ ¼å¼åŒ–æ—¥æœŸ
                const year = currentDateTime.getFullYear();
                const month = String(currentDateTime.getMonth() + 1).padStart(2, '0');
                const day = String(currentDateTime.getDate()).padStart(2, '0');
                const weekday = weekdays[currentDateTime.getDay()];
                
                // æ ¼å¼åŒ–æ—¶é—´
                const hours = String(currentDateTime.getHours()).padStart(2, '0');
                const minutes = String(currentDateTime.getMinutes()).padStart(2, '0');
                const seconds = String(currentDateTime.getSeconds()).padStart(2, '0');
                
                // æ›´æ–°ä¾§è¾¹æ æ˜¾ç¤º
                if (dateElement) dateElement.textContent = `${year}å¹´${month}æœˆ${day}æ—¥`;
                if (timeLargeElement) timeLargeElement.textContent = `${hours}:${minutes}:${seconds}`;
                if (weekdayElement) weekdayElement.textContent = weekday;
                
                // æ›´æ–°å¤´éƒ¨æ˜¾ç¤º
                if (headerTimeElement) {
                    headerTimeElement.textContent = `${year}å¹´${month}æœˆ${day}æ—¥ ${weekday} ${hours}:${minutes}:${seconds}`;
                }
            }
            
            updateTime();
            setInterval(updateTime, 1000);
        }
        
        // åˆ›å»ºæ‰‹ç»˜åœ°å›¾å›¾å±‚
        function createHandDrawnMapLayer() {
            // ä½¿ç”¨GitHubä¸Šçš„æ‰‹ç»˜åœ°å›¾
            campusImageOverlay = L.imageOverlay(handDrawnMapURL, yanqihuBounds, {
                opacity: 0.85,
                interactive: false,
                attribution: 'å›½ç§‘å¤§é›æ –æ¹–æ ¡åŒºæ‰‹ç»˜åœ°å›¾ Â© JiaweiYI',
                crossOrigin: 'anonymous'
            });
            
            // ç›‘å¬å›¾ç‰‡åŠ è½½äº‹ä»¶
            campusImageOverlay.on('load', function() {
                console.log('æ‰‹ç»˜åœ°å›¾åŠ è½½æˆåŠŸ');
                updateMapStatus('æ‰‹ç»˜åœ°å›¾å·²åŠ è½½');
            });
            
            campusImageOverlay.on('error', function() {
                console.log('æ‰‹ç»˜åœ°å›¾åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                updateMapStatus('åœ°å›¾åŠ è½½å¤±è´¥');
            });
            
            return campusImageOverlay;
        }
        
        // æ›´æ–°åœ°å›¾çŠ¶æ€æ˜¾ç¤º
        function updateMapStatus(status) {
            const statusElement = document.getElementById('mapStatus');
            if (statusElement) {
                statusElement.textContent = status;
                statusElement.style.background = status.includes('å¤±è´¥') ? '#ffebee' : '#e8f5e8';
                statusElement.style.color = status.includes('å¤±è´¥') ? '#c62828' : '#2e7d32';
            }
        }
        
        // æ·»åŠ å›¾å±‚æ§åˆ¶
        function addLayerControl() {
            if (layerControl) {
                map.removeControl(layerControl);
            }
            
            layerControl = L.control.layers(baseLayers, null, {
                position: 'topright',
                collapsed: true
            }).addTo(map);
            
            // æ·»åŠ æ¯”ä¾‹å°º
            L.control.scale({
                position: 'bottomleft',
                metric: true,
                imperial: false
            }).addTo(map);
            
            // ç›‘å¬å›¾å±‚åˆ‡æ¢äº‹ä»¶
            map.on('baselayerchange', function(e) {
                updateMapStatus('å½“å‰: ' + e.name);
            });
        }
        
        // åˆ¤æ–­æ´»åŠ¨æ˜¯å¦å·²è¿‡æœŸ
        function isActivityExpired(activity) {
            const activityDate = new Date(activity.date + 'T23:59:59');
            return activityDate < currentDateTime;
        }
        
        // è·å–æ´»åŠ¨çŠ¶æ€
        function getActivityStatus(activity) {
            return isActivityExpired(activity) ? 'past' : 'upcoming';
        }
        
        // æ’åºæ´»åŠ¨ï¼ˆæœªæ¥æ´»åŠ¨åœ¨å‰ï¼Œè¿‡æœŸæ´»åŠ¨åœ¨åï¼‰
        function sortActivitiesByTime(activities) {
            return activities.sort((a, b) => {
                const aExpired = isActivityExpired(a);
                const bExpired = isActivityExpired(b);
                
                if (aExpired && !bExpired) return 1;
                if (!aExpired && bExpired) return -1;
                
                // åŒä¸€çŠ¶æ€æŒ‰æ—¥æœŸæ’åº
                return new Date(a.date) - new Date(b.date);
            });
        }
        // åˆ›å»ºåœ°å›¾æ ‡è®°
        function createMarkers() {
            // æ¸…é™¤ç°æœ‰æ ‡è®°
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // æŒ‰åœ°ç‚¹åˆ†ç»„æ´»åŠ¨
            const locationGroups = {};
            filteredActivities.forEach(activity => {
                if (!locationGroups[activity.location]) {
                    locationGroups[activity.location] = [];
                }
                locationGroups[activity.location].push(activity);
            });
            
            // ä¸ºæ¯ä¸ªåœ°ç‚¹åˆ›å»ºæ ‡è®°
            Object.entries(locationGroups).forEach(([location, activities]) => {
                const coords = locationCoordinates[location];
                if (!coords) return;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å³å°†è¿›è¡Œçš„æ´»åŠ¨
                const hasUpcoming = activities.some(activity => !isActivityExpired(activity));
                const hasOnlyPast = activities.every(activity => isActivityExpired(activity));
                
                // åˆ›å»ºè‡ªå®šä¹‰æ ‡è®°
                const markerElement = document.createElement('div');
                let markerClass = 'campus-marker has-activities';
                
                if (hasUpcoming) {
                    markerClass += ' upcoming-activities';
                } else if (hasOnlyPast) {
                    markerClass += ' past-activities';
                }
                
                markerElement.className = markerClass;
                markerElement.innerHTML = activities.length;
                
                const marker = L.marker(coords, {
                    icon: L.divIcon({
                        html: markerElement.outerHTML,
                        className: 'custom-marker',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);
                
                // åˆ›å»ºå¼¹çª—å†…å®¹
                const sortedActivities = sortActivitiesByTime(activities);
                const popupContent = createPopupContent(location, sortedActivities);
                marker.bindPopup(popupContent, {
                    maxWidth: 350,
                    className: 'custom-popup'
                });
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                marker.on('click', () => {
                    selectLocation(location);
                    highlightActivitiesInSidebar(sortedActivities);
                });
                
                markers.push(marker);
            });
        }
        
        // åˆ›å»ºå¼¹çª—å†…å®¹
        function createPopupContent(location, activities) {
            const typeColors = {
                'å­¦æœ¯æ´»åŠ¨': '#e3f2fd',
                'å­¦ç”Ÿæ´»åŠ¨': '#f3e5f5',
                'å…¶ä»–æ´»åŠ¨': '#e8f5e8'
            };
            
            let content = `
                <div class="popup-header">
                    <div class="popup-title">${getLocationDisplayName(location)}</div>
                    <div class="popup-location">${activities.length}ä¸ªæ´»åŠ¨</div>
                </div>
                <div class="popup-activities">
            `;
            
            activities.forEach(activity => {
                const status = getActivityStatus(activity);
                const statusText = status === 'upcoming' ? 'å³å°†è¿›è¡Œ' : 'å·²ç»“æŸ';
                const statusClass = status === 'upcoming' ? 'status-upcoming' : 'status-past';
                
                content += `
                    <div class="popup-activity">
                        <div class="popup-activity-date">
                            ${activity.date} ${activity.weekday}
                            <span class="activity-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="popup-activity-title">${activity.title}</div>
                        <span class="popup-activity-type" style="background: ${typeColors[activity.type]}; color: ${getTypeColor(activity.type)}">${activity.type}</span>
                    </div>
                `;
            });
            
            content += '</div>';
            return content;
        }
        
        // è·å–åœ°ç‚¹æ˜¾ç¤ºåç§°
        function getLocationDisplayName(location) {
            return location.replace(/^(ä¸­å…³æ‘æ ¡åŒº-|é›æ –æ¹–æ ¡åŒº-|ç‰æ³‰è·¯æ ¡åŒº-|ä¸­å…³æ‘-|é›æ –æ¹–ä¸œåŒº|ç‰æ³‰è·¯-)/, '');
        }
        
        // è·å–ç±»å‹é¢œè‰²
        function getTypeColor(type) {
            switch(type) {
                case 'å­¦æœ¯æ´»åŠ¨': return '#1565c0';
                case 'å­¦ç”Ÿæ´»åŠ¨': return '#6a1b9a';
                case 'å…¶ä»–æ´»åŠ¨': return '#2e7d32';
                default: return '#333';
            }
        }
        
        // é€‰æ‹©åœ°ç‚¹
        function selectLocation(location) {
            selectedMarker = location;
            // åœ¨è¿™é‡Œå¯ä»¥æ·»åŠ åœ°ç‚¹é€‰æ‹©çš„è§†è§‰åé¦ˆ
        }
        
        // åœ¨ä¾§è¾¹æ é«˜äº®æ´»åŠ¨
        function highlightActivitiesInSidebar(activities) {
            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
            document.querySelectorAll('.activity-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            
            // é«˜äº®ç›¸å…³æ´»åŠ¨
            activities.forEach(activity => {
                const activityElement = document.querySelector(`[data-activity-id="${activity.date}-${activity.title}"]`);
                if (activityElement) {
                    activityElement.classList.add('selected');
                    activityElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        }
        
        // åˆå§‹åŒ–ä¾§è¾¹æ 
        function initSidebar() {
            // å¡«å……æ—¥æœŸç­›é€‰å™¨
            const dateFilter = document.getElementById('dateFilter');
            const uniqueDates = [...new Set(yanqihuActivities.map(a => a.date))].sort();
            uniqueDates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                const activity = yanqihuActivities.find(a => a.date === date);
                const status = isActivityExpired({date}) ? 'å·²ç»“æŸ' : 'å³å°†è¿›è¡Œ';
                option.textContent = `${date} ${activity.weekday} (${status})`;
                dateFilter.appendChild(option);
            });
            
            // æ¸²æŸ“æ´»åŠ¨åˆ—è¡¨
            renderActivityList();
            
            // ç»‘å®šç­›é€‰å™¨äº‹ä»¶
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFilter').addEventListener('change', applyFilters);
            document.getElementById('typeFilter').addEventListener('change', applyFilters);
        }
        
        // æ¸²æŸ“æ´»åŠ¨åˆ—è¡¨
        function renderActivityList() {
            const activityItems = document.getElementById('activityItems');
            
            if (filteredActivities.length === 0) {
                activityItems.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ´»åŠ¨</div>';
                return;
            }
            
            // æŒ‰æ—¶é—´æ’åºæ´»åŠ¨
            const sortedActivities = sortActivitiesByTime([...filteredActivities]);
            
            activityItems.innerHTML = sortedActivities.map(activity => {
                const status = getActivityStatus(activity);
                const statusText = status === 'upcoming' ? 'å³å°†è¿›è¡Œ' : 'å·²ç»“æŸ';
                const statusClass = status === 'upcoming' ? 'status-upcoming' : 'status-past';
                const itemClass = status === 'upcoming' ? 'upcoming' : 'expired';
                
                return `
                    <div class="activity-item ${itemClass}" data-activity-id="${activity.date}-${activity.title}" onclick="focusOnActivity('${activity.location}')">
                        <div class="activity-date">
                            ${activity.date} ${activity.weekday}
                            <span class="activity-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="activity-title">${activity.title}</div>
                        <div class="activity-meta">
                            <span class="activity-type ${getTypeClass(activity.type)}">${activity.type}</span>
                            <span class="activity-location">${getLocationDisplayName(activity.location)}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // åˆ›å»ºæ‰‹ç»˜åœ°å›¾å›¾å±‚
        function createHandDrawnMapLayer() {
            // ä½¿ç”¨window.fs.readFileè¯»å–ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶
            // è¿™é‡Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªå ä½ç¬¦ï¼Œå®é™…å›¾ç‰‡å°†é€šè¿‡æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½åŠ è½½
            
            // æ¨¡æ‹Ÿæ‰‹ç»˜åœ°å›¾çš„base64æ•°æ® - åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¿™å°†é€šè¿‡æ–‡ä»¶ä¸Šä¼ è·å¾—
            // ç°åœ¨å…ˆç”¨ä¸€ä¸ªé€æ˜çš„1x1åƒç´ å›¾ç‰‡ä½œä¸ºå ä½ç¬¦
            const placeholderImageData = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
            
            campusImageOverlay = L.imageOverlay(placeholderImageData, yanqihuBounds, {
                opacity: 0.8,
                interactive: false,
                attribution: 'å›½ç§‘å¤§é›æ –æ¹–æ ¡åŒºæ‰‹ç»˜åœ°å›¾'
            });
            
            return campusImageOverlay;
        }
        
        // æ·»åŠ å›¾å±‚æ§åˆ¶
        function addLayerControl() {
            if (layerControl) {
                map.removeControl(layerControl);
            }
            
            layerControl = L.control.layers(baseLayers, null, {
                position: 'topright',
                collapsed: false
            }).addTo(map);
            
            // æ·»åŠ æ¯”ä¾‹å°º
            L.control.scale({
                position: 'bottomleft',
                metric: true,
                imperial: false
            }).addTo(map);
        }
            updateStats();
        }
        
        // è·å–æ´»åŠ¨ç±»å‹CSSç±»
        function getTypeClass(type) {
            switch(type) {
                case 'å­¦æœ¯æ´»åŠ¨': return 'type-academic';
                case 'å­¦ç”Ÿæ´»åŠ¨': return 'type-student';
                case 'å…¶ä»–æ´»åŠ¨': return 'type-other';
                default: return 'type-other';
            }
        }
        
        // èšç„¦åˆ°æ´»åŠ¨åœ°ç‚¹
        function focusOnActivity(location) {
            const coords = locationCoordinates[location];
            if (coords) {
                map.setView(coords, 18);
                
                // æ‰¾åˆ°å¯¹åº”çš„æ ‡è®°å¹¶æ‰“å¼€å¼¹çª—
                markers.forEach(marker => {
                    const markerLatLng = marker.getLatLng();
                    if (Math.abs(markerLatLng.lat - coords[0]) < 0.0001 && Math.abs(markerLatLng.lng - coords[1]) < 0.0001) {
                        marker.openPopup();
                    }
                });
            }
        }
        
        // åº”ç”¨ç­›é€‰å™¨
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            filteredActivities = yanqihuActivities.filter(activity => {
                // æ—¶é—´çŠ¶æ€ç­›é€‰
                if (statusFilter) {
                    const activityStatus = getActivityStatus(activity);
                    if (statusFilter !== activityStatus) return false;
                }
                
                // æ—¥æœŸç­›é€‰
                if (dateFilter && activity.date !== dateFilter) return false;
                
                // ç±»å‹ç­›é€‰
                if (typeFilter && activity.type !== typeFilter) return false;
                
                return true;
            });
            
            // é‡æ–°æ¸²æŸ“
            renderActivityList();
            createMarkers();
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const visibleCount = document.getElementById('visibleCount');
            const locationCount = document.getElementById('locationCount');
            const upcomingCount = document.getElementById('upcomingCount');
            
            visibleCount.textContent = filteredActivities.length;
            
            const uniqueLocations = new Set(filteredActivities.map(a => a.location)).size;
            locationCount.textContent = uniqueLocations;
            
            const upcoming = filteredActivities.filter(a => !isActivityExpired(a)).length;
            upcomingCount.textContent = upcoming;
        }
        
        // å¤„ç†æ‰‹ç»˜åœ°å›¾ä¸Šä¼ 
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imageUrl = event.target.result;
                    
                    // ç§»é™¤ä¹‹å‰çš„å›¾ç‰‡è¦†ç›–å±‚
                    if (campusImageOverlay) {
                        map.removeLayer(campusImageOverlay);
                    }
                    
                    // ä½¿ç”¨é¢„è®¾çš„é›æ –æ¹–æ ¡åŒºåæ ‡èŒƒå›´
                    const imageBounds = yanqihuBounds;
                    
                    // åˆ›å»ºæ–°çš„å›¾ç‰‡è¦†ç›–å±‚
                    campusImageOverlay = L.imageOverlay(imageUrl, imageBounds, {
                        opacity: 0.85,
                        interactive: false,
                        attribution: 'å›½ç§‘å¤§é›æ –æ¹–æ ¡åŒºè‡ªå®šä¹‰åœ°å›¾'
                    });
                    
                    // æ›´æ–°å›¾å±‚æ§åˆ¶
                    baseLayers["ğŸ¨ æ‰‹ç»˜æ ¡å›­åœ°å›¾"] = campusImageOverlay;
                    
                    // é‡æ–°åˆ›å»ºå›¾å±‚æ§åˆ¶
                    if (layerControl) {
                        map.removeControl(layerControl);
                    }
                    
                    addLayerControl();
                    
                    // æ·»åŠ åˆ°åœ°å›¾å¹¶è°ƒæ•´è§†å›¾
                    campusImageOverlay.addTo(map);
                    map.fitBounds(imageBounds);
                    
                    updateMapStatus('è‡ªå®šä¹‰åœ°å›¾å·²åŠ è½½');
                    
                    alert('è‡ªå®šä¹‰æ‰‹ç»˜åœ°å›¾å·²ä¸Šä¼ å¹¶è®¾ç½®å®Œæˆï¼\n\nåæ ‡èŒƒå›´ï¼š\nå—: 40.3986Â°, è¥¿: 116.6673Â°\nåŒ—: 40.4164Â°, ä¸œ: 116.6914Â°\n\næ‚¨å¯ä»¥é€šè¿‡å³ä¸Šè§’çš„å›¾å±‚æ§åˆ¶æˆ–å¿«æ·é”®åˆ‡æ¢ä¸åŒçš„åœ°å›¾æ˜¾ç¤ºã€‚');
                };
                reader.readAsDataURL(file);
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });
        
        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // ESCé”®æ¸…é™¤æ‰€æœ‰ç­›é€‰
                document.getElementById('statusFilter').value = 'upcoming'; // é‡ç½®ä¸ºé»˜è®¤
                document.getElementById('dateFilter').value = '';
                document.getElementById('typeFilter').value = '';
                applyFilters();
            } else if (e.key === '1') {
                // æ•°å­—é”®1åˆ‡æ¢åˆ°æ‰‹ç»˜åœ°å›¾
                switchToLayer("ğŸ¨ æ‰‹ç»˜æ ¡å›­åœ°å›¾");
            } else if (e.key === '2') {
                // æ•°å­—é”®2åˆ‡æ¢åˆ°OpenStreetMap
                switchToLayer("ğŸŒ OpenStreetMap");
            } else if (e.key === '3') {
                // æ•°å­—é”®3åˆ‡æ¢åˆ°å«æ˜Ÿå›¾
                switchToLayer("ğŸ›°ï¸ å«æ˜Ÿåœ°å›¾");
            }
        });
        
        // åˆ‡æ¢å›¾å±‚çš„è¾…åŠ©å‡½æ•°
        function switchToLayer(targetLayerName) {
            // ç§»é™¤å½“å‰æ‰€æœ‰å›¾å±‚
            Object.values(baseLayers).forEach(layer => {
                if (map.hasLayer(layer)) {
                    map.removeLayer(layer);
                }
            });
            
            // æ·»åŠ ç›®æ ‡å›¾å±‚
            const targetLayer = baseLayers[targetLayerName];
            if (targetLayer) {
                targetLayer.addTo(map);
                updateMapStatus('å½“å‰: ' + targetLayerName.replace(/[ğŸ¨ğŸŒğŸ›°ï¸]\s/, ''));
            }
        }
        
        // ç§»é™¤ä¸éœ€è¦çš„addMapControlså‡½æ•°è°ƒç”¨
        // å›¾å±‚æ§åˆ¶å·²ç»åœ¨addLayerControlå‡½æ•°ä¸­å¤„ç†
    </script>
</body>
</html>